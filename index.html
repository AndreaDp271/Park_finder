<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Trova Parcheggio - Dati OSM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    #map {
      height: calc(100vh - 150px);
      width: 100%;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 3px;
      border: 1px solid #666;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .leaflet-popup-content {
      font-size: 14px;
      min-width: 180px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      z-index: 2000;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-top: none;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-blue-700 text-white p-3 shadow-md flex justify-between items-center h-[60px]">
    <h1 class="text-lg font-bold flex items-center gap-2 truncate">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      ParkMap
    </h1>
    <div class="flex gap-1">
      <button
        id="locate-btn"
        class="bg-white text-blue-700 p-2 rounded-full shadow-sm hover:bg-blue-50 transition"
        title="Mia Posizione"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 1.105 1.343 2 3 2s3-.895 3-2-1.343-2-3-2-3 .895-3 2z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21V12" />
        </svg>
      </button>
      <button
        id="refresh-btn"
        class="bg-blue-500 text-white p-2 rounded-full shadow-sm hover:bg-blue-600 transition"
        title="Aggiorna"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      </button>
    </div>
  </header>

  <div class="bg-white p-2 border-b flex relative h-[50px] items-center">
    <div class="w-full flex gap-1 relative">
      <input
        type="text"
        id="search-input"
        placeholder="Cerca città o CAP..."
        class="flex-grow p-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button id="search-btn" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-bold">Cerca</button>
      <div id="search-results" class="search-results shadow-lg rounded-b-md"></div>
    </div>
  </div>

  <div
    class="bg-white px-2 py-1 text-[10px] sm:text-xs flex flex-wrap gap-x-3 gap-y-1 justify-center border-b shadow-sm h-[40px] overflow-hidden items-center"
  >
    <div class="flex items-center"><span class="legend-dot bg-green-500"></span> Gratis</div>
    <div class="flex items-center"><span class="legend-dot bg-blue-600"></span> € Pagam.</div>
    <div class="flex items-center"><span class="legend-dot bg-purple-500"></span> Disco</div>
    <div class="flex items-center"><span class="legend-dot bg-orange-500"></span> Privato</div>
    <div class="flex items-center"><span class="legend-dot bg-gray-400"></span> Non definito</div>
  </div>

  <main class="relative">
    <div id="map"></div>
    <div id="loader" class="loading-overlay">
      <div class="bg-white p-3 rounded-lg shadow-xl flex items-center gap-3">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-700"></div>
        <span class="text-sm">Caricamento...</span>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const map = L.map("map", { zoomControl: false }).setView([45.4642, 9.19], 16);
    L.control.zoom({ position: "bottomright" }).addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OSM",
    }).addTo(map);

    let dataLayer = L.layerGroup().addTo(map);
    let userMarker = null;
    const loader = document.getElementById("loader");
    const searchInput = document.getElementById("search-input");
    const searchResults = document.getElementById("search-results");

    let lastLoadedBounds = null;
    let isFetching = false;

    const colors = {
      free: "#22c55e",
      paid: "#2563eb",
      timed: "#a855f7",
      private: "#f97316",
      unknown: "#94a3b8",
    };

    function getParkingType(tags) {
      const access = (tags.access || "").toLowerCase();
      if (["private", "customers", "permit", "residents"].includes(access)) {
        return "private";
      }

      const feeValue = (tags["parking:fee"] || tags.fee || "").toString().toLowerCase();
      const discValue = (tags["parking:disc"] || tags.disc || tags["parking:condition"] || "")
        .toString()
        .toLowerCase();
      const discKeywords = ["disc", "disco", "disk", "orario", "limited_wait"];

      if (discValue === "yes" || discKeywords.some(keyword => discValue.includes(keyword))) {
        return "timed";
      }

      if (["yes", "true", "paid", "customers", "ticket"].includes(feeValue)) {
        return "paid";
      }

      if (["no", "false", "free", "gratis"].includes(feeValue)) {
        return "free";
      }

      return "unknown";
    }

    function getAreaStyle(tags) {
      const type = getParkingType(tags);
      return {
        fillColor: colors[type],
        weight: 1.5,
        opacity: 0.8,
        color: "white",
        fillOpacity: 0.5,
      };
    }

    function getMarkerIcon(tags) {
      const type = getParkingType(tags);
      const color = colors[type];
      const html = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 1.5px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>`;

      return L.divIcon({
        html,
        className: "parking-dot",
        iconSize: [14, 14],
      });
    }

    function renderTags(tags) {
      const entries = Object.entries(tags || {}).sort(([a], [b]) => a.localeCompare(b));
      if (!entries.length) {
        return "<div class=\"text-xs\">Nessun tag disponibile</div>";
      }
      return `
        <table class="text-xs w-full">
          ${entries
            .map(
              ([key, value]) =>
                `<tr><td class="pr-2 align-top"><strong>${key}</strong></td><td>${value}</td></tr>`
            )
            .join("")}
        </table>
      `;
    }

    function getPopupContent(tags, lat, lon) {
      const title = tags.name || "Parcheggio";
      const navLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;

      return `
        <div class="text-xs font-sans">
          <b class="text-sm block border-b pb-1 mb-2 text-blue-800">${title}</b>
          ${renderTags(tags)}
          <a
            href="${navLink}"
            target="_blank"
            rel="noopener"
            class="mt-2 block w-full text-center bg-blue-600 text-white py-2 rounded-md font-bold shadow-sm active:bg-blue-800 no-underline"
          >
            VAI QUI
          </a>
        </div>
      `;
    }

    async function fetchParking(force = false) {
      if (isFetching) return;
      const currentBounds = map.getBounds();

      if (!force && lastLoadedBounds && lastLoadedBounds.contains(currentBounds)) {
        return;
      }

      const buffer = 0.008;
      const south = currentBounds.getSouth() - buffer;
      const west = currentBounds.getWest() - buffer;
      const north = currentBounds.getNorth() + buffer;
      const east = currentBounds.getEast() + buffer;
      const bbox = `${south},${west},${north},${east}`;

      isFetching = true;
      loader.style.display = "flex";

      const query = `
        [out:json][timeout:25];
        (
          nwr["amenity"="parking"](${bbox});
          nwr["amenity"="parking_space"](${bbox});
        );
        out center body;
        >;
        out skel qt;
      `;

      try {
        const response = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: query,
        });
        const data = await response.json();
        lastLoadedBounds = L.latLngBounds([south, west], [north, east]);
        processOSMData(data);
      } catch (error) {
        console.error("Errore Overpass:", error);
      } finally {
        isFetching = false;
        loader.style.display = "none";
      }
    }

    function processOSMData(data) {
      dataLayer.clearLayers();
      const nodes = {};
      data.elements.forEach(el => {
        if (el.type === "node") nodes[el.id] = [el.lat, el.lon];
      });

      data.elements.forEach(el => {
        if (!el.tags) return;
        const lat = el.lat || (el.center ? el.center.lat : null);
        const lon = el.lon || (el.center ? el.center.lon : null);

        if (el.tags.amenity === "parking" && el.type === "way" && el.nodes) {
          const coords = el.nodes.map(id => nodes[id]).filter(Boolean);
          if (coords.length > 2) {
            L.polygon(coords, getAreaStyle(el.tags))
              .bindPopup(getPopupContent(el.tags, lat, lon))
              .addTo(dataLayer);
            return;
          }
        }

        if (el.tags.amenity === "parking_space" || (el.tags.amenity === "parking" && el.type === "node")) {
          if (lat && lon) {
            L.marker([lat, lon], { icon: getMarkerIcon(el.tags) })
              .bindPopup(getPopupContent(el.tags, lat, lon))
              .addTo(dataLayer);
          }
        }
      });
    }

    async function searchLocation() {
      const query = searchInput.value;
      if (query.length < 3) return;

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=it&limit=5`
        );
        const results = await response.json();
        displaySearchResults(results);
      } catch (error) {
        console.error("Errore ricerca:", error);
      }
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = "";
      if (results.length === 0) {
        searchResults.style.display = "none";
        return;
      }

      results.forEach(result => {
        const div = document.createElement("div");
        div.className = "p-3 border-b hover:bg-gray-100 cursor-pointer text-sm";
        div.textContent = result.display_name;
        div.onclick = () => {
          map.setView([result.lat, result.lon], 16);
          searchResults.style.display = "none";
          searchInput.value = result.display_name;
          fetchParking(true);
        };
        searchResults.appendChild(div);
      });
      searchResults.style.display = "block";
    }

    document.getElementById("search-btn").onclick = searchLocation;
    searchInput.onkeypress = event => {
      if (event.key === "Enter") searchLocation();
    };

    document.addEventListener("click", event => {
      if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
        searchResults.style.display = "none";
      }
    });

    document.getElementById("locate-btn").onclick = () => {
      map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true });
    };

    map.on("locationfound", event => {
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.circleMarker(event.latlng, {
        radius: 8,
        fillColor: "#3b82f6",
        color: "white",
        weight: 2,
        opacity: 1,
        fillOpacity: 1,
      })
        .addTo(map)
        .bindPopup("Sei qui");
      fetchParking();
    });

    document.getElementById("refresh-btn").onclick = () => fetchParking(true);

    map.on("moveend", () => {
      if (map.getZoom() >= 15) fetchParking();
    });

    fetchParking();
  </script>
</body>
</html>
