<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking - Mappa Accessi</title>
    
    <!-- Icone per salvataggio su Desktop/Home Screen -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/100/parking.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/50/parking.png">
    <meta name="apple-mobile-web-app-title" content="Smart Parking">
    <meta name="application-name" content="Smart Parking">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: calc(100vh - 80px); width: 100%; background: #f1f5f9; }
        .loader { border-top-color: #3b82f6; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .leaflet-interactive { cursor: pointer !important; }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .leaflet-popup-content { margin: 8px; line-height: 1.4; }
        
        .legend-container {
            transition: all 0.3s ease;
            max-height: 40px;
            overflow: hidden;
        }
        .legend-container.expanded {
            max-height: 300px;
        }
        /* Stile per il link OSM */
        .osm-link { color: #2563eb; text-decoration: none; font-weight: bold; }
        .osm-link:hover { text-decoration: underline; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">

    <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 sticky top-0 z-[1001] gap-4">
        <div class="flex items-center gap-3 shrink-0">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-2.286-6.857L2 11l6.857-2.286L11 2l2.286 6.857L20 11l-6.857 2.286L9 20z" />
                </svg>
            </div>
            <div class="hidden sm:block">
                <h1 class="font-bold text-lg leading-none italic uppercase tracking-tight text-blue-700">Smart Parking</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Per Una Sosta Certa</p>
            </div>
        </div>
        
        <div class="relative flex-1 max-w-md">
            <input type="text" id="citySearch" placeholder="Cerca Citt√† o CAP..." class="w-full bg-slate-100 border-none rounded-full py-2 px-4 pl-10 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-2.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <div id="searchResults" class="absolute top-full left-0 right-0 bg-white shadow-xl rounded-b-xl mt-1 hidden z-[2000] border border-slate-200 overflow-hidden"></div>
        </div>

        <div class="flex gap-2 shrink-0">
            <select id="filterType" class="bg-slate-100 border-none rounded-full px-3 md:px-4 py-2 text-[12px] md:text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                <option value="all">Tutti</option>
                <option value="free">Gratis</option>
                <option value="paid">Pagamento</option>
                <option value="timed">Disco Orario</option>
                <option value="restricted">Speciali</option>
            </select>
            <button id="refreshData" class="bg-white border border-slate-200 hover:bg-slate-50 rounded-full p-2 text-slate-600 transition-colors shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>
    </header>

    <main class="relative">
        <div id="map"></div>
        
        <div id="legend" class="absolute top-4 right-4 z-[1000] bg-white/95 backdrop-blur-sm p-3 rounded-2xl shadow-xl border border-slate-200 text-[11px] legend-container w-40 cursor-pointer md:cursor-default" onclick="this.classList.toggle('expanded')">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <span class="font-bold text-slate-700 uppercase tracking-tighter text-[9px]">Legenda</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 md:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500/40 border-2 border-green-600 rounded"></div><span class="font-medium">Gratis</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500/40 border-2 border-blue-600 rounded"></div><span class="font-medium">Pagamento</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-purple-500/40 border-2 border-purple-600 rounded"></div><span class="font-medium">Disco Orario</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-pink-400/70 border-2 border-pink-600 rounded"></div><span class="font-medium">Posto Rosa</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-slate-700/70 border-2 border-slate-900 rounded"></div><span class="font-medium">Bus / Mezzi</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-orange-500/40 border-2 border-orange-600 rounded"></div><span class="font-medium">Riservato</span></div>
            </div>
        </div>

        <div id="statusIndicator" class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-[1000] items-center gap-2 text-blue-600 font-medium text-xs bg-white/90 backdrop-blur px-4 py-2 rounded-full border border-blue-100 shadow-md">
            <div class="loader w-3 h-3 border-2 border-slate-200 rounded-full"></div>
            <span id="statusText">Ricerca...</span>
        </div>

        <!-- Pulsante Schermo Intero -->
        <button id="fullscreenBtn" class="absolute bottom-28 right-6 z-[1000] bg-white text-slate-700 p-3 rounded-full shadow-xl border border-slate-200 hover:bg-slate-50 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
        </button>

        <button id="gpsBtn" class="absolute bottom-10 right-6 z-[1000] bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </main>

    <script>
        let map, parkingLayerGroup, fetchTimer, searchTimer;
        const renderedIds = new Set();
        
        const overpassEndpoints = [
            'https://overpass-api.de/api/interpreter',
            'https://lz4.overpass-api.de/api/interpreter'
        ];

        const zPriority = { pink: 2000, heavy: 1900, restricted: 1800, timed: 1700, paid: 1600, free: 1500 };

        const colors = {
            free: { fill: '#22c55e', stroke: '#166534', label: 'Gratuito' },
            paid: { fill: '#3b82f6', stroke: '#1e40af', label: 'A Pagamento' },
            timed: { fill: '#a855f7', stroke: '#6b21a8', label: 'Disco Orario' }, 
            restricted: { fill: '#f97316', stroke: '#9a3412', label: 'Riservato' },
            pink: { fill: '#f472b6', stroke: '#be185d', label: 'Posto Rosa' },
            heavy: { fill: '#334155', stroke: '#0f172a', label: 'Bus / HGV' }
        };

        function formatOSMConditions(str, context = 'fee') {
            if (!str) return '';
            let s = str.toLowerCase();
            s = s.replace(/00:00-24:00/g, 'tutto il giorno').replace(/24\/7/g, 'sempre');

            if (context === 'access') {
                s = s.replace(/no\s*@/g, '<span class="text-red-700 font-extrabold italic">‚õî Chiuso</span> nei seguenti orari: ')
                     .replace(/yes\s*@/g, '<span class="text-green-700 font-bold uppercase text-[9px]">‚úÖ Aperto</span> nei seguenti orari: ');
            } else {
                s = s.replace(/no\s*@/g, '<span class="text-green-700 font-bold italic uppercase text-[9px]">Gratis</span> nei seguenti orari: ')
                     .replace(/yes\s*@/g, '<span class="text-blue-700 font-bold italic uppercase text-[9px]">Pagamento</span> nei seguenti orari: ');
            }

            return s.replace(/;/g, '<br>')
                    .replace(/ph/g, 'Festivi')
                    .replace(/\btu\b/g, 'Mar').replace(/\bwe\b/g, 'Mer')
                    .replace(/\bth\b/g, 'Gio').replace(/\bfr\b/g, 'Ven')
                    .replace(/\bsa\b/g, 'Sab').replace(/\bsu\b/g, 'Dom')
                    .replace(/\bmo\b/g, 'Lun')
                    .replace(/mo-fr/g, 'Lun-Ven')
                    .replace(/sa-su/g, 'Sab-Dom')
                    .replace(/\(/g, '').replace(/\)/g, '');
        }

        function initMap() {
            map = L.map('map', { zoomControl: false, preferCanvas: false }).setView([45.6713, 11.9284], 18);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; <a href="https://www.openstreetmap.org/about" target="_blank" class="osm-link">OSM</a>' 
            }).addTo(map);

            L.control.zoom({ position: 'topleft' }).addTo(map);
            parkingLayerGroup = L.layerGroup().addTo(map);

            map.on('moveend', () => {
                clearTimeout(fetchTimer);
                fetchTimer = setTimeout(fetchData, 600);
            });
            
            setupCitySearch();
            setupGPS();
            setupFullscreen(); // Inizializza pulsante fullscreen
            fetchData();
            
            if (window.innerWidth >= 768) {
                document.getElementById('legend').classList.add('expanded');
            }
        }

        window.navigateTo = (lat, lon) => {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
            window.open(url, '_blank');
        };

        window.openInID = (type, id) => {
            const url = `https://www.openstreetmap.org/edit?editor=id&${type}=${id}`;
            window.open(url, '_blank');
        };

        function setupGPS() {
            document.getElementById('gpsBtn').onclick = () => {
                map.locate({setView: true, maxZoom: 18});
            };
            map.on('locationfound', (e) => {
                L.circle(e.latlng, { radius: 10, color: '#3b82f6', fillOpacity: 0.5 }).addTo(map);
            });
        }

        function setupFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            if (!document.documentElement.requestFullscreen && !document.documentElement.webkitRequestFullscreen) {
                // Nascondi se non supportato (opzionale, ma utile per compatibilit√† iOS vecchi)
                // btn.style.display = 'none'; 
                // Lo lasciamo visibile come richiesto, ma potrebbe non funzionare su alcuni iPhone senza PWA
            }
            
            btn.onclick = () => {
                if (!document.fullscreenElement) {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                        document.documentElement.webkitRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) { /* Safari */
                        document.webkitExitFullscreen();
                    }
                }
            };
        }

        function setupCitySearch() {
            const input = document.getElementById('citySearch');
            const results = document.getElementById('searchResults');

            input.oninput = () => {
                clearTimeout(searchTimer);
                const query = input.value;
                if (query.length < 3) { results.classList.add('hidden'); return; }

                searchTimer = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=it&limit=5`);
                        const data = await res.json();
                        results.innerHTML = '';
                        if (data.length > 0) {
                            results.classList.remove('hidden');
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm border-b border-slate-100 last:border-0';
                                div.innerText = item.display_name;
                                div.onclick = () => {
                                    map.setView([item.lat, item.lon], 16);
                                    results.classList.add('hidden');
                                    input.value = item.display_name;
                                };
                                results.appendChild(div);
                            });
                        }
                    } catch (e) {}
                }, 400);
            };
        }

        async function fetchData() {
            if (map.getZoom() < 14) return;
            document.getElementById('statusIndicator').style.display = 'flex';
            document.getElementById('statusText').innerText = "Cerca stalli...";

            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            const query = `[out:json][timeout:25];(way["amenity"~"parking|parking_space"]["amenity"!="bicycle_parking"](${bbox});relation["amenity"~"parking|parking_space"]["amenity"!="bicycle_parking"](${bbox});node["amenity"~"parking|parking_space"]["amenity"!="bicycle_parking"](${bbox}););out body geom;`;

            for (let endpoint of overpassEndpoints) {
                try {
                    const response = await fetch(`${endpoint}?data=${encodeURIComponent(query)}`);
                    if (!response.ok) continue;
                    const data = await response.json();
                    if (data.elements) {
                        renderData(data.elements);
                        document.getElementById('statusIndicator').style.display = 'none';
                        return;
                    }
                } catch (e) {}
            }
        }

        function renderData(elements) {
            const filter = document.getElementById('filterType').value;
            elements.forEach(el => {
                if (renderedIds.has(el.id)) return;
                const tags = el.tags || {};
				const amenity = tags.amenity || '';
				const isParkingSpace = amenity === 'parking_space';
                if (tags.amenity === 'bicycle_parking' || tags.parking_space === 'normal') return;

                let latLngs;
                let center;
                if (el.type === 'node') {
                    const radius = 0.00002;
                    latLngs = [[el.lat - radius, el.lon - radius], [el.lat + radius, el.lon - radius], [el.lat + radius, el.lon + radius], [el.lat - radius, el.lon + radius]];
                    center = [el.lat, el.lon];
                } else if (el.geometry) {
                    latLngs = el.geometry.map(pt => [pt.lat, pt.lon]);
                    center = [el.geometry[0].lat, el.geometry[0].lon];
                } else return;

                let type = 'free';
                const fee = tags.fee || tags['parking:fee'];
                const feeCond = tags['fee:conditional'] || '';
                const access = tags.access || '';
                const accessCond = tags['access:conditional'] || '';
                const maxstay = tags.maxstay || tags['parking:condition'] === 'disc';
                const isWomen = tags['capacity:women'] || tags.female === 'yes' || tags['parking:condition'] === 'women' || tags['parking_space'] === 'women';
                const isHeavy = tags.hgv === 'yes' || tags.bus === 'yes' || tags['parking:hgv'] === 'yes' || tags['parking_space'] === 'bus';

                if (isWomen) type = 'pink';
                else if (isHeavy) type = 'heavy';
                else if (access && !['yes', 'public', 'permissive'].includes(access)) type = 'restricted';
                else if (maxstay) type = 'timed';
                else if (fee === 'yes' || (feeCond && !feeCond.includes('no @'))) type = 'paid';

                if (filter !== 'all' && type !== filter) {
                    if (!(filter === 'restricted' && (type === 'pink' || type === 'heavy' || type === 'restricted'))) return;
                }

                const style = colors[type];
                const layer = L.polygon(latLngs, {
                    color: style.stroke,
                    fillColor: style.fill,
                    fillOpacity: (type === 'pink' || type === 'heavy') ? 0.8 : 0.5,
                    weight: (type === 'pink' || type === 'heavy') ? 3 : 1,
                    zIndexOffset: (zPriority[type] || 0) + (isParkingSpace ? 100 : 0)

                });

                let feeDetails = '';
                if (type === 'paid' || feeCond) {
                    feeDetails = `<div class="mt-2 p-2 bg-blue-50 border border-blue-100 rounded text-[11px] text-blue-800 italic leading-tight">
                        <b class="block not-italic text-blue-900 mb-0.5 tracking-tighter uppercase text-[9px]">Informazioni Tariffa:</b>
                        ${feeCond ? formatOSMConditions(feeCond, 'fee') : 'Sosta a pagamento'}
                    </div>`;
                }

                let accessDetails = '';
                if (accessCond) {
                    accessDetails = `<div class="mt-2 p-2 bg-red-50 border border-red-100 rounded text-[11px] text-red-800 leading-tight">
                        <b class="block text-red-900 mb-0.5 tracking-tighter uppercase text-[9px]">Accesso Condizionato:</b>
                        ${formatOSMConditions(accessCond, 'access')}
                    </div>`;
                }

                let categoryTag = '';
                if (isWomen) categoryTag = '<span class="bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full text-[8px] font-bold border border-pink-200">üö∫ STALLO ROSA</span>';
                if (isHeavy) categoryTag = '<span class="bg-slate-800 text-white px-2 py-0.5 rounded-full text-[8px] font-bold">üöå BUS/HGV</span>';

                const content = `
                    <div class="text-[12px] min-w-[210px] max-w-[250px]">
                        <div class="flex justify-between items-center border-b mb-2 pb-1 gap-2">
                            <b class="text-slate-800 uppercase text-[10px] tracking-tight">${style.label}</b>
                            ${categoryTag}
                        </div>
                        
                        <div class="mb-2">
                            ${tags.name ? `<p class="font-bold text-slate-900 leading-tight">${tags.name}</p>` : ''}
                            ${tags.operator ? `<p class="text-[10px] text-slate-500 italic">Gestore: ${tags.operator}</p>` : ''}
                        </div>

                        ${accessDetails}
                        ${feeDetails}
                        
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${tags.maxstay ? `<div class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">‚è±Ô∏è Max: ${tags.maxstay}</div>` : ''}
                            ${tags.capacity ? `<div class="bg-slate-100 text-slate-700 px-2 py-1 rounded text-[10px] font-bold">üöó Posti: ${tags.capacity}</div>` : ''}
                        </div>

                        <div class="flex flex-col gap-2 mt-3">
                            <button onclick="navigateTo(${center[0]}, ${center[1]})" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-md transition-all active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                                PORTAMI QUI
                            </button>
                            
                            <button onclick="openInID('${el.type}', ${el.id})" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-1.5 rounded-lg flex items-center justify-center gap-2 text-[10px] transition-all border border-slate-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                MODIFICA SU iD (OSM)
                            </button>
                        </div>
                    </div>
                `;
                
                layer.bindPopup(content, { className: 'custom-popup' }).addTo(parkingLayerGroup);
                if (type === 'pink' || type === 'heavy') layer.bringToFront();
                renderedIds.add(el.id);
            });
        }

        document.getElementById('refreshData').onclick = () => { renderedIds.clear(); parkingLayerGroup.clearLayers(); fetchData(); };
        document.getElementById('filterType').onchange = () => { renderedIds.clear(); parkingLayerGroup.clearLayers(); fetchData(); };

        window.onload = initMap;
    </script>
</body>
</html>
