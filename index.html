<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ParkMap - OSM Parking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        #map {
            position: absolute;
            top: 60px;
            bottom: 0;
            left: 0;
            right: 0;
        }
        #topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #1e293b;
            color: #f9fafb;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            gap: 8px;
            z-index: 1000;
        }
        #title {
            font-weight: 600;
            margin-right: 8px;
            white-space: nowrap;
        }
        #searchBox {
            flex: 1;
            display: flex;
            gap: 4px;
        }
        #searchInput {
            flex: 1;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            font-size: 14px;
        }
        button {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        #searchBtn {
            background: #3b82f6;
            color: #f9fafb;
        }
        #gpsBtn {
            background: #22c55e;
            color: #064e3b;
        }
        #status {
            font-size: 12px;
            margin-left: 6px;
            white-space: nowrap;
            max-width: 25%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .popup-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .popup-section {
            margin-top: 4px;
            font-size: 13px;
        }
        .popup-section span.label {
            font-weight: 600;
        }
        .popup-links a {
            display: inline-block;
            margin-right: 6px;
            margin-top: 6px;
            font-size: 13px;
            text-decoration: none;
            color: #2563eb;
        }
        .popup-links a:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            #title {
                display: none;
            }
            #status {
                display: none;
            }
        }
    </style>
</head>
<body>
<div id="topbar">
    <div id="title">ParkMap OSM</div>
    <div id="searchBox">
        <input id="searchInput" type="text" placeholder="Cerca una località (es. Milano Duomo)">
        <button id="searchBtn">Cerca</button>
    </div>
    <button id="gpsBtn">GPS</button>
    <div id="status"></div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Inizializza mappa (centrata su Milano di default)
    var map = L.map('map').setView([45.4642, 9.19], 15);

    // Base OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layer gruppi
    var parkingAreasLayer = L.layerGroup().addTo(map);      // amenity=parking
    var parkingSpacesLayer = L.layerGroup().addTo(map);     // amenity=parking_space speciali

    // Controllo layer
    L.control.layers(null, {
        "Aree parcheggio": parkingAreasLayer,
        "Posti speciali": parkingSpacesLayer
    }, { collapsed: false }).addTo(map);

    var statusEl = document.getElementById('status');

    function setStatus(msg) {
        statusEl.textContent = msg || '';
    }

    // Funzione helper: costruisci URL Google Maps per navigazione
    function buildGMapsUrl(lat, lon) {
        // Url semplice con parametro q=lat,lon
        return 'https://www.google.com/maps?q=' + encodeURIComponent(lat + ',' + lon);
    }

    // Funzione helper: costruisci URL iD editor
    function buildIdUrl(osmType, osmId, lat, lon, zoom) {
        zoom = zoom || map.getZoom() || 18;
        var base = 'https://www.openstreetmap.org/edit?editor=id';
        var center = '#map=' + zoom + '/' + lat + '/' + lon;
        var sel = '';
        if (osmType && osmId) {
            // osmType: 'node' | 'way' | 'relation'
            sel = '&' + osmType + '=' + osmId;
        }
        return base + sel + center;
    }

    // Costruisci descrizione popup comune
    function buildPopupContent(props, geom, osmMeta) {
        var name = props.name || props.ref || '(senza nome)';
        var operator = props.operator || '-';
        var access = props.access || '-';
        var fee = (props.fee === 'yes') ? 'a pagamento' :
                  (props.fee === 'no') ? 'gratuito' :
                  (props.fee || '-');
        var condFee = props['fee:conditional'] || props['parking:condition'] || props['parking:condition:time_interval'] || '-';
        var lat = geom.coordinates[1];
        var lon = geom.coordinates[0];

        var gmapsUrl = buildGMapsUrl(lat, lon);
        var idUrl = buildIdUrl(osmMeta.type, osmMeta.id, lat, lon);

        var html = '';
        html += '<div class="popup-title">' + name + '</div>';

        html += '<div class="popup-section"><span class="label">Operatore:</span> ' + operator + '</div>';
        html += '<div class="popup-section"><span class="label">Accesso:</span> ' + access + '</div>';
        html += '<div class="popup-section"><span class="label">Costo:</span> ' + fee + '</div>';
        html += '<div class="popup-section"><span class="label">Costo / condizioni:</span> ' + condFee + '</div>';

        if (props.capacity) {
            html += '<div class="popup-section"><span class="label">Capacità:</span> ' + props.capacity + '</div>';
        }
        if (props.parking_space) {
            html += '<div class="popup-section"><span class="label">Tipo posto:</span> ' + props.parking_space + '</div>';
        }

        html += '<div class="popup-links">';
        html += '<a href="' + gmapsUrl + '" target="_blank" rel="noopener">Naviga con Google Maps</a>';
        html += '<a href="' + idUrl + '" target="_blank" rel="noopener">Modifica su OSM iD</a>';
        html += '</div>';

        return html;
    }

    // Query Overpass per area corrente
    function fetchParking() {
        var bounds = map.getBounds();
        var s = bounds.getSouth();
        var w = bounds.getWest();
        var n = bounds.getNorth();
        var e = bounds.getEast();

        setStatus('Carico parcheggi in zona…');

        // Overpass QL:
        // 1) amenity=parking
        // 2) amenity=parking_space con parking_space != normal
        var query = `
            [out:json][timeout:25];
            (
              way["amenity"="parking"](${s},${w},${n},${e});
              relation["amenity"="parking"](${s},${w},${n},${e});
              node["amenity"="parking"](${s},${w},${n},${e});

              node["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
              way["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
              relation["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
            );
            out body;
            >;
            out skel qt;
        `;

        var url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);

        fetch(url)
            .then(function (res) { return res.json(); })
            .then(function (data) {
                renderParking(data);
                setStatus('Parcheggi aggiornati');
                setTimeout(function(){ setStatus(''); }, 3000);
            })
            .catch(function (err) {
                console.error(err);
                setStatus('Errore nel caricamento dei parcheggi');
            });
    }

    // Rendering dati Overpass
    function renderParking(data) {
        parkingAreasLayer.clearLayers();
        parkingSpacesLayer.clearLayers();

        if (!data || !data.elements) return;

        // Index nodi per costruire poligoni da way
        var nodesIndex = {};
        data.elements.forEach(function (el) {
            if (el.type === 'node') {
                nodesIndex[el.id] = el;
            }
        });

        data.elements.forEach(function (el) {
            var tags = el.tags || {};
            if (!tags.amenity) return;

            // Costruisci geometria semplice per popup / marker
            var geom = null;

            if (el.type === 'node') {
                geom = {
                    type: 'Point',
                    coordinates: [el.lon, el.lat]
                };
            } else if (el.type === 'way' && el.nodes) {
                var coords = el.nodes.map(function (nid) {
                    var n = nodesIndex[nid];
                    return n ? [n.lat, n.lon] : null;
                }).filter(Boolean);

                if (coords.length > 1) {
                    // prendi il primo nodo come riferimento per popup
                    geom = {
                        type: 'Point',
                        coordinates: [coords[0][1], coords[0][0]]
                    };
                }
            } else if (el.type === 'relation' && el.members) {
                // prendi il primo membro con ruolo outer o qualsiasi membro node/way
                var center = null;
                for (var i = 0; i < el.members.length; i++) {
                    var m = el.members[i];
                    if (m.type === 'node' && nodesIndex[m.ref]) {
                        center = nodesIndex[m.ref];
                        break;
                    }
                }
                if (center) {
                    geom = {
                        type: 'Point',
                        coordinates: [center.lon, center.lat]
                    };
                }
            }

            if (!geom) return;

            var osmMeta = { type: el.type, id: el.id };

            // amenity=parking (layer intermedio)
            if (tags.amenity === 'parking') {
                var popupHtml = buildPopupContent(tags, geom, osmMeta);
                var marker = L.circleMarker([geom.coordinates[1], geom.coordinates[0]], {
                    radius: 7,
                    color: '#1d4ed8',
                    weight: 2,
                    fillColor: '#60a5fa',
                    fillOpacity: 0.6
                }).bindPopup(popupHtml);
                marker.addTo(parkingAreasLayer);
            }

            // amenity=parking_space (layer superiore), escludendo parking_space=normal
            if (tags.amenity === 'parking_space') {
                var psType = tags.parking_space;
                if (psType && psType !== 'normal') {
                    var popupHtml2 = buildPopupContent(tags, geom, osmMeta);
                    var color = '#dc2626'; // rosso per posti speciali
                    var fill = '#f97373';
                    var marker2 = L.circleMarker([geom.coordinates[1], geom.coordinates[0]], {
                        radius: 6,
                        color: color,
                        weight: 2,
                        fillColor: fill,
                        fillOpacity: 0.7
                    }).bindPopup(popupHtml2);
                    marker2.addTo(parkingSpacesLayer);
                }
            }
        });
    }

    // Ricarica quando l'utente smette di muovere la mappa
    var fetchTimeout = null;
    map.on('moveend', function () {
        if (fetchTimeout) clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(fetchParking, 400);
    });

    // Prima chiamata
    fetchParking();

    // Ricerca per località con Nominatim
    function geocode(query) {
        if (!query) return;
        setStatus('Cerco "' + query + '"…');

        var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' +
                  encodeURIComponent(query) + '&limit=1&addressdetails=0';

        fetch(url, {
            headers: {
                'Accept-Language': 'it'
            }
        })
            .then(function (res) { return res.json(); })
            .then(function (results) {
                if (!results || !results.length) {
                    setStatus('Nessun risultato per "' + query + '"');
                    return;
                }
                var r = results[0];
                var lat = parseFloat(r.lat);
                var lon = parseFloat(r.lon);
                map.setView([lat, lon], 17);
                setStatus('Trovato: ' + (r.display_name || query));
            })
            .catch(function (err) {
                console.error(err);
                setStatus('Errore nella ricerca');
            });
    }

    document.getElementById('searchBtn').addEventListener('click', function () {
        geocode(document.getElementById('searchInput').value.trim());
    });

    document.getElementById('searchInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            geocode(document.getElementById('searchInput').value.trim());
        }
    });

    // Localizzazione GPS
    document.getElementById('gpsBtn').addEventListener('click', function () {
        if (!navigator.geolocation) {
            setStatus('Geolocalizzazione non supportata');
            return;
        }
        setStatus('Cerco la tua posizione…');
        navigator.geolocation.getCurrentPosition(function (pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            map.setView([lat, lon], 17);
            setStatus('Posizione trovata');
        }, function (err) {
            console.error(err);
            setStatus('Impossibile ottenere la posizione');
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    });
</script>
</body>
</html>
