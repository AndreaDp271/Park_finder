<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ParkMap - OSM Parking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        #map {
            position: absolute;
            top: 60px;
            bottom: 0;
            left: 0;
            right: 0;
        }
        #topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #1e293b;
            color: #f9fafb;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            gap: 8px;
            z-index: 1000;
        }
        #title {
            font-weight: 600;
            margin-right: 8px;
            white-space: nowrap;
        }
        #searchBox {
            flex: 1;
            display: flex;
            gap: 4px;
        }
        #searchInput {
            flex: 1;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            font-size: 14px;
        }
        button {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        #searchBtn {
            background: #3b82f6;
            color: #f9fafb;
        }
        #gpsBtn {
            background: #22c55e;
            color: #064e3b;
        }
        #status {
            font-size: 12px;
            margin-left: 6px;
            white-space: nowrap;
            max-width: 25%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .popup-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .popup-section {
            margin-top: 4px;
            font-size: 13px;
        }
        .popup-section span.label {
            font-weight: 600;
        }
        .popup-links a {
            display: inline-block;
            margin-right: 6px;
            margin-top: 6px;
            font-size: 13px;
            text-decoration: none;
            color: #2563eb;
        }
        .popup-links a:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            #title {
                display: none;
            }
            #status {
                display: none;
            }
        }
    </style>
</head>
<body>
<div id="topbar">
    <div id="title">ParkMap OSM</div>
    <div id="searchBox">
        <input id="searchInput" type="text" placeholder="Cerca una località (es. Milano Duomo)">
        <button id="searchBtn">Cerca</button>
    </div>
    <button id="gpsBtn">GPS</button>
    <div id="status"></div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Inizializza mappa (Milano di default)
    var map = L.map('map').setView([45.4642, 9.19], 15);

    // Base OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layer gruppi
    var parkingAreasLayer = L.layerGroup().addTo(map);      // amenity=parking (poligoni)
    var parkingSpacesLayer = L.layerGroup().addTo(map);     // amenity=parking_space speciali (marker)

    // Controllo layer
    L.control.layers(null, {
        "Aree parcheggio": parkingAreasLayer,
        "Posti speciali": parkingSpacesLayer
    }, { collapsed: false }).addTo(map);

    var statusEl = document.getElementById('status');

    function setStatus(msg) {
        statusEl.textContent = msg || '';
    }

    // URL Google Maps semplice
    function buildGMapsUrl(lat, lon) {
        return 'https://www.google.com/maps?q=' + encodeURIComponent(lat + ',' + lon);
    }

    // URL iD editor su oggetto
    function buildIdUrl(osmType, osmId, lat, lon, zoom) {
        zoom = zoom || map.getZoom() || 18;
        var base = 'https://www.openstreetmap.org/edit?editor=id';
        var center = '#map=' + zoom + '/' + lat + '/' + lon;
        var sel = '';
        if (osmType && osmId) {
            sel = '&' + osmType + '=' + osmId;
        }
        return base + sel + center;
    }

    function buildPopupContent(tags, lat, lon, osmMeta) {
        var name = tags.name || tags.ref || '(senza nome)';
        var operator = tags.operator || '-';
        var access = tags.access || '-';
        var fee = (tags.fee === 'yes') ? 'a pagamento' :
                  (tags.fee === 'no') ? 'gratuito' :
                  (tags.fee || '-');
        var condFee = tags['fee:conditional'] || tags['parking:condition'] || tags['parking:condition:time_interval'] || '-';

        var gmapsUrl = buildGMapsUrl(lat, lon);
        var idUrl = buildIdUrl(osmMeta.type, osmMeta.id, lat, lon);

        var html = '';
        html += '<div class="popup-title">' + name + '</div>';
        html += '<div class="popup-section"><span class="label">Operatore:</span> ' + operator + '</div>';
        html += '<div class="popup-section"><span class="label">Accesso:</span> ' + access + '</div>';
        html += '<div class="popup-section"><span class="label">Costo:</span> ' + fee + '</div>';
        html += '<div class="popup-section"><span class="label">Costo / condizioni:</span> ' + condFee + '</div>';

        if (tags.capacity) {
            html += '<div class="popup-section"><span class="label">Capacità:</span> ' + tags.capacity + '</div>';
        }
        if (tags.parking_space) {
            html += '<div class="popup-section"><span class="label">Tipo posto:</span> ' + tags.parking_space + '</div>';
        }

        html += '<div class="popup-links">';
        html += '<a href="' + gmapsUrl + '" target="_blank" rel="noopener">Naviga con Google Maps</a>';
        html += '<a href="' + idUrl + '" target="_blank" rel="noopener">Modifica su OSM iD</a>';
        html += '</div>';

        return html;
    }

    // Query Overpass per area corrente (con geom)
    function fetchParking() {
        var bounds = map.getBounds();
        var s = bounds.getSouth();
        var w = bounds.getWest();
        var n = bounds.getNorth();
        var e = bounds.getEast();

        setStatus('Carico parcheggi in zona…');

        // out geom per ottenere geometria completa delle way/relation
        var query = `
            [out:json][timeout:25];
            (
              way["amenity"="parking"](${s},${w},${n},${e});
              relation["amenity"="parking"](${s},${w},${n},${e});
              node["amenity"="parking"](${s},${w},${n},${e});

              node["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
              way["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
              relation["amenity"="parking_space"]["parking_space"]["parking_space"!="normal"](${s},${w},${n},${e});
            );
            out body geom;
        `;

        var url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);

        fetch(url)
            .then(function (res) { return res.json(); })
            .then(function (data) {
                renderParking(data);
                parkingSpacesLayer.bringToFront();  // ← questa riga forza i posti speciali in cima
                parkingAreasLayer.bringToBack();
                setStatus('Parcheggi aggiornati');
                setTimeout(function(){ setStatus(''); }, 3000);
            })
            .catch(function (err) {
                console.error(err);
                setStatus('Errore nel caricamento dei parcheggi');
            });

    }

    // Rendering
    function renderParking(data) {
    parkingAreasLayer.clearLayers();
    parkingSpacesLayer.clearLayers();

    if (!data || !data.elements) return;

    data.elements.forEach(function (el) {
        var tags = el.tags || {};
        if (!tags.amenity) return;

        var osmMeta = { type: el.type, id: el.id };

        // --- amenity=parking: aree / linee / nodi ---
        if (tags.amenity === 'parking') {
            if (el.geometry && el.geometry.length > 0) {
                var latlngs = el.geometry.map(function (g) {
                    return [g.lat, g.lon];
                });

                var first = latlngs[0];
                var last = latlngs[latlngs.length - 1];
                var isClosed = first[0] === last[0] && first[1] === last[1];

                var layer;
                if (isClosed && latlngs.length > 2) {
                    layer = L.polygon(latlngs, {
                        color: '#1d4ed8',
                        weight: 2,
                        fillColor: '#60a5fa',
                        fillOpacity: 0.4
                    });
                } else if (latlngs.length > 1) {
                    layer = L.polyline(latlngs, {
                        color: '#1d4ed8',
                        weight: 2
                    });
                } else {
                    // fallback a nodo singolo
                    var lat = el.lat || (latlngs[0] && latlngs[0][0]);
                    var lon = el.lon || (latlngs[0] && latlngs[0][1]);
                    if (!lat || !lon) return;
                    layer = L.circleMarker([lat, lon], {
                        radius: 6,
                        color: '#1d4ed8',
                        weight: 2,
                        fillColor: '#60a5fa',
                        fillOpacity: 0.6
                    });
                }

                var centerIdx = Math.floor(latlngs.length / 2);
                var centerLat = latlngs[centerIdx][0];
                var centerLon = latlngs[centerIdx][1];
                var popupHtml = buildPopupContent(tags, centerLat, centerLon, osmMeta);
                layer.bindPopup(popupHtml);
                layer.addTo(parkingAreasLayer);

            } else if (el.type === 'node') {
                var latN = el.lat;
                var lonN = el.lon;
                var popupHtmlN = buildPopupContent(tags, latN, lonN, osmMeta);
                var m = L.circleMarker([latN, lonN], {
                    radius: 6,
                    color: '#1d4ed8',
                    weight: 2,
                    fillColor: '#60a5fa',
                    fillOpacity: 0.6
                }).bindPopup(popupHtmlN);
                m.addTo(parkingAreasLayer);
            }
        }

        // --- amenity=parking_space: aree sopra tutto, solo speciali (!= normal) ---
        if (tags.amenity === 'parking_space') {
            var psType = tags.parking_space;
            if (!psType || psType === 'normal') return;

            // Se ho geometria completa, provo a fare poligono
            if (el.geometry && el.geometry.length > 0) {
                var latlngsPs = el.geometry.map(function (g) {
                    return [g.lat, g.lon];
                });

                var firstPs = latlngsPs[0];
                var lastPs = latlngsPs[latlngsPs.length - 1];
                var isClosedPs = firstPs[0] === lastPs[0] && firstPs[1] === lastPs[1];

                var centerIdxPs = Math.floor(latlngsPs.length / 2);
                var centerLatPs = latlngsPs[centerIdxPs][0];
                var centerLonPs = latlngsPs[centerIdxPs][1];

                var layerPs;
                if (isClosedPs && latlngsPs.length > 2) {
                    // area del singolo posto (in cima)
                    layerPs = L.polygon(latlngsPs, {
                        color: '#b91c1c',
                        weight: 2,
                        fillColor: '#f97373',
                        fillOpacity: 0.7
                    });
                } else if (latlngsPs.length > 1) {
                    // stallo come linea
                    layerPs = L.polyline(latlngsPs, {
                        color: '#b91c1c',
                        weight: 3
                    });
                } else {
                    // fallback a nodo marker
                    var latPs = el.lat || centerLatPs;
                    var lonPs = el.lon || centerLonPs;
                    layerPs = L.circleMarker([latPs, lonPs], {
                        radius: 6,
                        color: '#b91c1c',
                        weight: 2,
                        fillColor: '#f97373',
                        fillOpacity: 0.9
                    });
                }

                var popupHtmlPs = buildPopupContent(tags, centerLatPs, centerLonPs, osmMeta);
                layerPs.bindPopup(popupHtmlPs);
                layerPs.addTo(parkingSpacesLayer);

            } else if (el.type === 'node') {
                // nodo semplice
                var latPsN = el.lat;
                var lonPsN = el.lon;
                var popupHtmlPsN = buildPopupContent(tags, latPsN, lonPsN, osmMeta);
                var m2 = L.circleMarker([latPsN, lonPsN], {
                    radius: 6,
                    color: '#b91c1c',
                    weight: 2,
                    fillColor: '#f97373',
                    fillOpacity: 0.9
                }).bindPopup(popupHtmlPsN);
                m2.addTo(parkingSpacesLayer);
            }
        }
    });
}


    // Trigger su moveend
    var fetchTimeout = null;
    map.on('moveend', function () {
        if (fetchTimeout) clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(fetchParking, 400);
    });

    // Prima chiamata
    fetchParking();

    // Geocoding Nominatim
    function geocode(query) {
        if (!query) return;
        setStatus('Cerco "' + query + '"…');

        var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' +
                  encodeURIComponent(query) + '&limit=1&addressdetails=0';

        fetch(url, {
            headers: {
                'Accept-Language': 'it'
            }
        })
            .then(function (res) { return res.json(); })
            .then(function (results) {
                if (!results || !results.length) {
                    setStatus('Nessun risultato per "' + query + '"');
                    return;
                }
                var r = results[0];
                var lat = parseFloat(r.lat);
                var lon = parseFloat(r.lon);
                map.setView([lat, lon], 17);
                setStatus('Trovato: ' + (r.display_name || query));
            })
            .catch(function (err) {
                console.error(err);
                setStatus('Errore nella ricerca');
            });
    }

    document.getElementById('searchBtn').addEventListener('click', function () {
        geocode(document.getElementById('searchInput').value.trim());
    });

    document.getElementById('searchInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            geocode(document.getElementById('searchInput').value.trim());
        }
    });

    // Localizzazione GPS
    document.getElementById('gpsBtn').addEventListener('click', function () {
        if (!navigator.geolocation) {
            setStatus('Geolocalizzazione non supportata');
            return;
        }
        setStatus('Cerco la tua posizione…');
        navigator.geolocation.getCurrentPosition(function (pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            map.setView([lat, lon], 17);
            setStatus('Posizione trovata');
        }, function (err) {
            console.error(err);
            setStatus('Impossibile ottenere la posizione');
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    });
</script>
</body>
</html>
