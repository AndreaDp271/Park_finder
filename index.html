<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trova Parcheggio - Dati OSM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        html, body { 
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
            position: fixed; background-color: #f3f4f6; touch-action: manipulation;
        }
        #app-container { position: relative; height: 100%; width: 100%; }
        #top-ui {
            position: absolute; top: 0; left: 0; right: 0; z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #search-bar { height: 55px; display: flex; align-items: center; padding: 0 8px; }
        #legend-bar { height: 35px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #map-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            padding-top: 150px; z-index: 1;
        }
        #map { height: 100%; width: 100%; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 4px; border: 1px solid #666; }
        
        .loading-overlay {
            position: absolute; top: 160px; left: 50%; transform: translateX(-50%);
            z-index: 1500; display: none;
        }

        .parking-dot { display: flex !important; align-items: center; justify-content: center; }

        #info-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 3000; align-items: center; justify-content: center; padding: 20px;
        }

        .leaflet-popup-content { font-size: 14px; min-width: 230px; }
        .button-group { display: flex; gap: 8px; margin-top: 10px; }
        .nav-button {
            flex: 1; display: flex !important; align-items: center; justify-content: center;
            background-color: #1d4ed8 !important; color: #ffffff !important; 
            padding: 10px !important; border-radius: 6px !important; font-weight: bold !important; 
            text-decoration: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .edit-button {
            width: 42px; display: flex !important; align-items: center; justify-content: center;
            background-color: #4b5563 !important; color: #ffffff !important; 
            padding: 10px !important; border-radius: 6px !important; 
            text-decoration: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="font-sans">

    <div id="app-container">
        <div id="top-ui">
            <header class="bg-blue-700 text-white">
                <h1 class="text-lg font-bold flex items-center gap-2 truncate">
                    <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 20l-5-2V4l5 2m0 14l5-2m-5 2v-14m5 14l5-2V4l-5 2m0 14v-14"></path></svg>
                    ParkMap
                </h1>
                <div class="flex gap-2">
                    <button id="locate-btn" class="bg-white text-blue-700 p-2 rounded-full shadow-sm">
                        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 2v3m0 14v3m10-10h-3M5 12H2"></path></svg>
                    </button>
                    <button id="refresh-btn" class="bg-blue-500 text-white p-2 rounded-full shadow-sm">
                        <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
            </header>

            <div id="search-bar" class="bg-white border-b">
                <div class="w-full flex gap-1 relative">
                    <input type="text" id="search-input" placeholder="Cerca citt√† o CAP..." class="flex-grow p-2 text-sm border rounded-md">
                    <button id="search-btn" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-bold">Cerca</button>
                    <div id="search-results" class="absolute top-full left-0 right-0 bg-white z-[2100] max-h-[250px] overflow-y-auto border hidden shadow-xl"></div>
                </div>
            </div>

            <div id="legend-bar" class="bg-white border-b">
                <div class="flex items-center gap-3 overflow-x-auto no-scrollbar py-1">
                    <div class="flex items-center text-[10px] font-bold"><span class="legend-dot bg-green-500"></span> Gratis</div>
                    <div class="flex items-center text-[10px] font-bold"><span class="legend-dot bg-blue-600"></span> Pagamento</div>
                    <div class="flex items-center text-[10px] font-bold"><span class="legend-dot bg-purple-500"></span> Disco Orario</div>
                    <div class="flex items-center text-[10px] font-bold"><span class="legend-dot bg-orange-500"></span> Privato</div>
                </div>
                <button id="info-btn" class="bg-gray-100 hover:bg-gray-200 text-blue-700 w-7 h-7 rounded-full flex items-center justify-center border font-serif font-bold italic">i</button>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div id="loader" class="loading-overlay">
                <div class="bg-white p-3 rounded-full shadow-2xl flex items-center gap-3 border border-blue-100">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-700"></div>
                    <span class="text-xs font-bold text-blue-800">Aggiornamento...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Info Simboli -->
    <div id="info-modal">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-sm">
            <h2 class="text-lg font-bold border-b pb-2 mb-4">Legenda Stalli</h2>
            <div class="space-y-3 text-sm">
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-white border border-gray-400"></span> Normale / Generico</div>
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-yellow-400 border border-gray-600 flex items-center justify-center text-[10px]">üöö</span> Carico/Scarico (Delivery)</div>
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-yellow-400 border border-gray-600 flex items-center justify-center text-[10px]">‚ôø</span> Disabili</div>
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-pink-300 border border-gray-600 flex items-center justify-center text-[10px]">‚ôÄ</span> Parcheggio Rosa (Women)</div>
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-yellow-400 border border-gray-600 flex items-center justify-center text-[10px]">üöñ</span> Taxi</div>
                <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-full bg-yellow-400 border border-gray-600 flex items-center justify-center text-[10px]">üöì</span> Polizia</div>
            </div>
            <button id="close-info" class="w-full mt-6 bg-blue-700 text-white py-2 rounded-lg font-bold">Chiudi</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false, tap: false }).setView([45.4642, 9.1900], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '¬© OSM',
            maxZoom: 19 
        }).addTo(map);

        let dataLayer = L.layerGroup().addTo(map);
        let isFetching = false;
        
        const loader = document.getElementById('loader');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const infoModal = document.getElementById('info-modal');

        const colors = {
            free: '#22c55e', 
            paid: '#2563eb', 
            timed: '#a855f7',
            private: '#f97316', 
            disabled: '#facc15',
            delivery: '#facc15',
            women: '#f9a8d4',
            special: '#facc15',
            default: '#ffffff'
        };

        // Funzione migliorata per la traduzione dei tag OSM
        function humanizeCondition(str, isFee = false) {
            if (!str) return '';
            
            let human = str
                .replace(/^no\s*@\s*/gi, 'Vietato ')
                .replace(/^yes\s*@\s*/gi, isFee ? 'Pagamento ' : 'Consentito ')
                .replace(/^private\s*@\s*/gi, 'Solo privati ')
                .replace(/^customers\s*@\s*/gi, 'Solo clienti ')
                .replace(/^permit\s*@\s*/gi, 'Solo con permesso ')
                .replace(/^residents\s*@\s*/gi, 'Solo residenti ')
                .replace(/Mo/g, 'lun').replace(/Tu/g, 'mar').replace(/We/g, 'mer')
                .replace(/Th/g, 'gio').replace(/Fr/g, 'ven').replace(/Sa/g, 'sab')
                .replace(/Su/g, 'dom').replace(/PH/g, 'festivi')
                .replace(/00:00-24:00/g, 'tutto il giorno')
                .replace(/;/g, ' | ')
                .replace(/\(/g, '').replace(/\)/g, '')
                .trim();

            // Trasforma intervalli orari
            human = human.replace(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/g, 'dalle $1 alle $2');
            
            // Pulisce doppioni
            human = human.replace(/dalle\s+dalle/gi, 'dalle');
            
            return human.charAt(0).toUpperCase() + human.slice(1);
        }

        function getParkingType(tags) {
            // 1. Logica specifica per stalli singoli (punti)
            if (tags.amenity === 'parking_space') {
                const space = tags.parking_space || '';
                if (tags.disabled === 'yes' || space === 'disabled') return 'disabled';
                if (space === 'delivery') return 'delivery';
                if (space === 'women') return 'women';
                if (['taxi', 'police', 'emergency'].includes(space)) return 'special';
                return 'default';
            }

            // 2. Logica per aree e accessi (poligoni o nodi generici)
            const acc = tags.access || '';
            if (['private', 'customers', 'permit', 'residents', 'employees'].includes(acc)) return 'private';

            const fee = tags.fee || '';
            if (fee === 'yes' || tags['fee:conditional'] || tags['fee:amount']) return 'paid';

            const cond = tags['parking:condition'] || tags['parking:condition:both'] || '';
            if (cond.includes('disc') || tags['maxstay'] || tags['maxstay:conditional']) return 'timed';

            return 'free';
        }

        function getIconChar(tags) {
            const space = tags.parking_space || '';
            if (tags.disabled === 'yes' || space === 'disabled') return '‚ôø';
            if (space === 'delivery') return 'üöö';
            if (space === 'women') return '‚ôÄ';
            if (space === 'taxi') return 'üöñ';
            if (space === 'police') return 'üöì';
            return '';
        }

        function getMarkerIcon(tags) {
            const type = getParkingType(tags);
            const iconChar = getIconChar(tags);
            const bgColor = colors[type];
            const html = `<div style="background-color: ${bgColor}; width: 14px; height: 14px; border-radius: 50%; border: 1.5px solid #666; display: flex; align-items: center; justify-content: center; font-size: 8px; color: black; font-weight: bold;">${iconChar}</div>`;
            return L.divIcon({ html: html, className: 'parking-dot', iconSize: [14, 14] });
        }

        function getPopupContent(el, lat, lon) {
            const tags = el.tags;
            const type = getParkingType(tags);
            const isSpace = tags.amenity === 'parking_space';
            
            let title = tags.name || (isSpace ? `Posto ${tags.parking_space || 'Auto'}` : "Parcheggio");
            let body = `<div class="mb-2 space-y-1">`;
            
            if (isSpace) {
                const spaceType = tags.parking_space || 'standard';
                body += `<div class="font-bold text-gray-600 uppercase text-[10px]">Stallo: ${spaceType}</div>`;
            }

            // Stato Accesso
            if (tags.access && tags.access !== 'yes') {
                body += `<div class="text-orange-700 font-bold">Accesso: ${tags.access.toUpperCase()}</div>`;
            }

            // Stato Tariffa
            let tariffaLabel = "Gratis";
            if (type === 'paid') tariffaLabel = '<span class="text-blue-700 font-bold">A PAGAMENTO</span>';
            if (type === 'timed') tariffaLabel = '<span class="text-purple-700 font-bold">DISCO ORARIO</span>';
            body += `<div><b>Tariffa:</b> ${tariffaLabel}</div>`;

            // Condizioni complesse (Fee Conditional)
            if (tags['fee:conditional']) {
                body += `<div class="bg-blue-50 p-1.5 rounded text-[11px] border border-blue-100 mt-1">
                    <b>Regole Pagamento:</b><br>${humanizeCondition(tags['fee:conditional'], true)}
                </div>`;
            }

            // Condizioni Sosta (Parking Condition)
            if (tags['parking:condition'] || tags['parking:condition:both']) {
                const condStr = tags['parking:condition'] || tags['parking:condition:both'];
                body += `<div class="bg-gray-50 p-1.5 rounded text-[11px] border border-gray-200 mt-1">
                    <b>Limitazioni:</b><br>${humanizeCondition(condStr)}
                </div>`;
            }

            // Tempo Massimo
            if (tags.maxstay) {
                body += `<div class="font-bold text-purple-700 text-[11px] mt-1">
                    ‚è± Limite: ${tags.maxstay.replace('mins', 'min')}
                </div>`;
            }

            body += `</div>`;
            const navLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            const editLink = `https://www.openstreetmap.org/edit?editor=id&${el.type}=${el.id}#map=19/${lat}/${lon}`;

            return `<div class="text-xs">
                <b class="text-sm block border-b pb-1 mb-1 text-blue-800">${title}</b>
                ${body}
                <div class="button-group">
                    <a href="${navLink}" target="_blank" class="nav-button">VAI QUI</a>
                    <a href="${editLink}" target="_blank" class="edit-button">‚úèÔ∏è</a>
                </div>
            </div>`;
        }

        async function fetchParking() {
            if (isFetching || map.getZoom() < 15) return;
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            isFetching = true;
            loader.style.display = 'block';
            
            const q = `[out:json][timeout:25];(nwr["amenity"~"parking|parking_space"](${bbox}););out center body;>;out skel qt;`;
            try {
                const r = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: q });
                const d = await r.json();
                processData(d);
            } catch (e) { console.error(e); }
            finally { isFetching = false; loader.style.display = 'none'; }
        }

        function processData(data) {
            dataLayer.clearLayers();
            const nodes = {};
            data.elements.forEach(el => { if (el.type === 'node') nodes[el.id] = [el.lat, el.lon]; });
            data.elements.forEach(el => {
                if (!el.tags) return;
                const lat = el.lat || (el.center ? el.center.lat : null);
                const lon = el.lon || (el.center ? el.center.lon : null);
                if (!lat || !lon) return;

                const type = getParkingType(el.tags);

                if (el.tags.amenity === 'parking' && el.type === 'way') {
                    const coords = el.nodes.map(id => nodes[id]).filter(c => c);
                    if (coords.length > 2) {
                        L.polygon(coords, { 
                            fillColor: colors[type], 
                            weight: 2, color: 'white', fillOpacity: 0.5 
                        }).bindPopup(getPopupContent(el, lat, lon)).addTo(dataLayer);
                    }
                } else {
                    L.marker([lat, lon], { icon: getMarkerIcon(el.tags) })
                    .bindPopup(getPopupContent(el, lat, lon)).addTo(dataLayer);
                }
            });
        }

        // UI Helpers
        document.getElementById('info-btn').onclick = () => infoModal.style.display = 'flex';
        document.getElementById('close-info').onclick = () => infoModal.style.display = 'none';
        document.getElementById('locate-btn').onclick = () => map.locate({setView: true, maxZoom: 18});
        document.getElementById('refresh-btn').onclick = fetchParking;
        map.on('moveend', fetchParking);

        async function search() {
            const v = searchInput.value;
            if (v.length < 3) return;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(v)}&countrycodes=it&limit=5`);
            const json = await r.json();
            searchResults.innerHTML = '';
            json.forEach(res => {
                const d = document.createElement('div');
                d.className = 'p-3 border-b hover:bg-gray-100 cursor-pointer text-sm';
                d.textContent = res.display_name;
                d.onclick = () => { map.setView([res.lat, res.lon], 18); searchResults.style.display = 'none'; fetchParking(); };
                searchResults.appendChild(d);
            });
            searchResults.style.display = 'block';
        }
        document.getElementById('search-btn').onclick = search;
        
        window.onload = fetchParking;
    </script>
</body>
</html>
