<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trova Parcheggio - Dati OSM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
            position: fixed;
            background-color: #f3f4f6;
            touch-action: manipulation;
        }

        #app-container { 
            position: relative;
            height: 100%; 
            width: 100%; 
        }

        #top-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #search-bar { height: 55px; display: flex; align-items: center; padding: 0 8px; }
        #legend-bar { height: 35px; display: flex; align-items: center; justify-content: center; }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding-top: 150px; 
            z-index: 1;
        }

        #map { 
            height: 100%; 
            width: 100%; 
        }
        
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 3px; border: 1px solid #666; }
        
        .loading-overlay {
            position: absolute; top: 160px; left: 50%; transform: translateX(-50%);
            z-index: 1500; display: none;
        }

        .leaflet-popup-content { font-size: 14px; min-width: 200px; }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .nav-button {
            flex: 1;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background-color: #1d4ed8 !important; 
            color: #ffffff !important; 
            padding: 10px !important; 
            border-radius: 6px !important; 
            font-weight: bold !important; 
            text-decoration: none !important; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .edit-button {
            width: 42px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background-color: #4b5563 !important; 
            color: #ffffff !important; 
            padding: 10px !important; 
            border-radius: 6px !important; 
            text-decoration: none !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; z-index: 2100; max-height: 250px;
            overflow-y: auto; border: 1px solid #ccc; border-top: none;
            display: none;
        }
    </style>
</head>
<body class="font-sans">

    <div id="app-container">
        <div id="top-ui">
            <!-- Header -->
            <header class="bg-blue-700 text-white">
                <h1 class="text-lg font-bold flex items-center gap-2 truncate">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    </svg>
                    ParkMap
                </h1>
                <div class="flex gap-2">
                    <!-- Pulsante Posizione Standard -->
                    <button id="locate-btn" class="bg-white text-blue-700 p-2 rounded-full shadow-sm active:bg-gray-200" title="Trova la mia posizione">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 0v4m0-4h4m-4 0H8m12 0a8 8 0 11-16 0 8 8 0 0116 0z" />
                            <circle cx="12" cy="12" r="2" fill="currentColor" />
                        </svg>
                    </button>
                    <button id="refresh-btn" class="bg-blue-500 text-white p-2 rounded-full shadow-sm active:bg-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Ricerca -->
            <div id="search-bar" class="bg-white border-b">
                <div class="w-full flex gap-1 relative">
                    <input type="text" id="search-input" placeholder="Cerca città o CAP..." class="flex-grow p-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="search-btn" class="bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-bold">Cerca</button>
                    <div id="search-results" class="search-results shadow-xl"></div>
                </div>
            </div>

            <!-- Legenda -->
            <div id="legend-bar" class="bg-white px-2 text-[10px] sm:text-xs flex flex-wrap gap-x-3 gap-y-1 border-b">
                <div class="flex items-center"><span class="legend-dot bg-green-500"></span> Gratis</div>
                <div class="flex items-center"><span class="legend-dot bg-blue-600"></span> Pagam.</div>
                <div class="flex items-center"><span class="legend-dot bg-purple-500"></span> Disco</div>
                <div class="flex items-center"><span class="legend-dot bg-orange-500"></span> Privato</div>
                <div class="flex items-center"><span class="legend-dot bg-yellow-400 flex items-center justify-center text-[7px]">♿</span> Disab.</div>
            </div>
        </div>

        <!-- Mappa Container -->
        <div id="map-container">
            <div id="map"></div>
            <div id="loader" class="loading-overlay">
                <div class="bg-white p-3 rounded-full shadow-2xl flex items-center gap-3 border border-blue-100">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-700"></div>
                    <span class="text-xs font-bold text-blue-800">Aggiornamento...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map', { 
            zoomControl: false,
            tap: false,
            dragging: true,
            touchZoom: true
        }).setView([45.4642, 9.1900], 17); 
        
        if (window.innerWidth > 768) {
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OSM',
            maxZoom: 19
        }).addTo(map);

        let dataLayer = L.layerGroup().addTo(map);
        let userMarker = null;
        const loader = document.getElementById('loader');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        
        let lastLoadedBounds = null;
        let isFetching = false;

        const colors = {
            free: '#22c55e',
            paid: '#2563eb',
            timed: '#a855f7',
            private: '#f97316',
            disabled: '#facc15',
            default: '#94a3b8'
        };

        function getParkingType(tags) {
            if (tags.disabled === 'yes' || tags['parking_space'] === 'disabled' || tags['capacity:disabled'] > 0) return 'disabled';
            const access = tags.access || '';
            if (access === 'private' || access === 'customers' || access === 'permit' || access === 'residents') return 'private';
            const fee = tags.fee || '';
            if (fee === 'yes') return 'paid';
            const condition = tags['parking:condition'] || '';
            if (condition.includes('disc') || tags['maxstay'] || tags['parking:condition'] === 'limited_wait') return 'timed';
            return 'free';
        }

        function getAreaStyle(tags) {
            const type = getParkingType(tags);
            return {
                fillColor: colors[type],
                weight: 1.5,
                opacity: 0.8,
                color: 'white',
                fillOpacity: 0.5
            };
        }

        function getMarkerIcon(tags) {
            const type = getParkingType(tags);
            const color = colors[type];
            const isDis = type === 'disabled';
            const html = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 1.5px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 8px; color: black; font-weight: bold;">${isDis ? '♿' : ''}</div>`;
            return L.divIcon({ html: html, className: 'parking-dot', iconSize: [14, 14] });
        }

        function getPopupContent(el, lat, lon) {
            const tags = el.tags;
            const type = getParkingType(tags);
            const isSpace = tags.amenity === 'parking_space';
            let title = tags.name || (isSpace ? "Posto Auto" : "Parcheggio");
            
            const navLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            
            // Link per l'editor iD di OSM
            const osmType = el.type === 'node' ? 'node' : (el.type === 'way' ? 'way' : 'relation');
            const editLink = `https://www.openstreetmap.org/edit?editor=id&${osmType}=${el.id}#map=19/${lat}/${lon}`;

            return `
                <div class="text-xs font-sans">
                    <b class="text-sm block border-b pb-1 mb-1 text-blue-800">${title}</b>
                    <div class="mb-2">
                        <b>Tipo:</b> ${type.toUpperCase()}<br>
                        <b>Accesso:</b> ${tags.access || 'pubblico'}<br>
                        ${tags.capacity ? `<b>Posti:</b> ${tags.capacity}<br>` : ''}
                    </div>
                    <div class="button-group">
                        <a href="${navLink}" target="_blank" class="nav-button">VAI QUI</a>
                        <a href="${editLink}" target="_blank" class="edit-button" title="Modifica su OSM">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </a>
                    </div>
                </div>
            `;
        }

        async function fetchParking(force = false) {
            if (isFetching) return;
            const currentBounds = map.getBounds();
            if (!force && lastLoadedBounds && lastLoadedBounds.contains(currentBounds)) return;

            const buffer = 0.008; 
            const south = currentBounds.getSouth() - buffer;
            const west = currentBounds.getWest() - buffer;
            const north = currentBounds.getNorth() + buffer;
            const east = currentBounds.getEast() + buffer;
            const bbox = `${south},${west},${north},${east}`;

            isFetching = true;
            loader.style.display = 'block';
            
            const query = `[out:json][timeout:25];(nwr["amenity"="parking"](${bbox});nwr["amenity"="parking_space"](${bbox}););out center body;>;out skel qt;`;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                lastLoadedBounds = L.latLngBounds([south, west], [north, east]);
                processOSMData(data);
            } catch (error) {
                console.error(error);
            } finally {
                isFetching = false;
                loader.style.display = 'none';
            }
        }

        function processOSMData(data) {
            dataLayer.clearLayers();
            const nodes = {};
            data.elements.forEach(el => { if (el.type === 'node') nodes[el.id] = [el.lat, el.lon]; });

            data.elements.forEach(el => {
                if (!el.tags) return;
                const lat = el.lat || (el.center ? el.center.lat : null);
                const lon = el.lon || (el.center ? el.center.lon : null);

                if (el.tags.amenity === 'parking' && el.type === 'way' && el.nodes) {
                    const coords = el.nodes.map(id => nodes[id]).filter(c => c);
                    if (coords.length > 2) {
                        L.polygon(coords, getAreaStyle(el.tags)).bindPopup(getPopupContent(el, lat, lon)).addTo(dataLayer);
                        return;
                    }
                }
                if (el.tags.amenity === 'parking_space' || (el.tags.amenity === 'parking' && el.type === 'node')) {
                    if (lat && lon) {
                        L.marker([lat, lon], { icon: getMarkerIcon(el.tags) }).bindPopup(getPopupContent(el, lat, lon)).addTo(dataLayer);
                    }
                }
            });
        }

        async function searchLocation() {
            const query = searchInput.value;
            if (query.length < 3) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=it&limit=5`);
                const results = await response.json();
                displaySearchResults(results);
            } catch (error) { console.error(error); }
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            if (results.length === 0) { searchResults.style.display = 'none'; return; }
            results.forEach(res => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b hover:bg-gray-100 cursor-pointer text-sm font-medium';
                div.textContent = res.display_name;
                div.onclick = () => {
                    map.setView([res.lat, res.lon], 18);
                    searchResults.style.display = 'none';
                    searchInput.value = res.display_name;
                    fetchParking(true);
                };
                searchResults.appendChild(div);
            });
            searchResults.style.display = 'block';
        }

        document.getElementById('search-btn').onclick = searchLocation;
        searchInput.onkeypress = (e) => { if (e.key === 'Enter') searchLocation(); };
        document.addEventListener('click', (e) => { if (!searchInput.contains(e.target)) searchResults.style.display = 'none'; });

        document.getElementById('locate-btn').onclick = () => {
            map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
        };

        map.on('locationfound', (e) => {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: '#3b82f6', color: 'white', weight: 2, fillOpacity: 1 }).addTo(map);
            fetchParking();
        });

        document.getElementById('refresh-btn').onclick = () => fetchParking(true);
        map.on('moveend', () => { if (map.getZoom() >= 14) fetchParking(); });

        window.addEventListener('load', () => {
            setTimeout(() => {
                map.invalidateSize();
                fetchParking();
            }, 300);
        });
    </script>
</body>
</html>
