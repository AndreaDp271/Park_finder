<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ParkMap - Trova il tuo posto</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ParkMap">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2991/2991231.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2991/2991231.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --bg-main: #f8fafc;
        }

        html, body { 
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
            position: fixed; background-color: var(--bg-main); touch-action: manipulation;
        }
        
        #app-container { position: relative; height: 100%; width: 100%; display: flex; flex-direction: column; }
        
        #top-ui {
            position: absolute; top: 12px; left: 12px; right: 12px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        header { 
            height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
        }

        #search-container {
            height: 56px; display: flex; align-items: center; padding: 0 4px;
        }

        #map-container {
            flex-grow: 1; position: relative; z-index: 1;
        }
        
        #map { height: 100%; width: 100%; background: #e5e7eb; }

        .logo-gradient {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .parking-space-icon { 
            display: flex !important; 
            align-items: center; 
            justify-content: center; 
            background: white;
            border: 2px solid #1e293b;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            font-size: 11px;
        }

        .charging-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.8));
        }

        .leaflet-popup-content-wrapper { border-radius: 24px; padding: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 16px; font-size: 14px; min-width: 250px; }

        .btn-action {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; text-decoration: none !important;
            letter-spacing: 0.05em;
            color: white !important;
        }
        .btn-action:active { transform: scale(0.92); }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        #legend-floating {
            position: absolute; bottom: 30px; left: 12px; right: 80px;
            z-index: 1000; padding: 0;
            display: flex; gap: 8px; flex-wrap: wrap;
            pointer-events: none;
        }
        
        .legend-item {
            display: flex; align-items: center; gap: 6px; font-size: 11px;
            font-weight: 700; color: #475569; white-space: nowrap;
            background: white; padding: 6px 12px; border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        .popup-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            background: #f1f5f9;
            color: #334155;
            margin-top: 4px;
            line-height: 1.2;
            width: 100%;
        }

        /* Pulsante flottante aggiorna */
        .btn-float {
            position: absolute; bottom: 30px; right: 12px; z-index: 1000;
            width: 56px; height: 56px; border-radius: 20px;
            background: white; color: #1e293b; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 1px solid rgba(255,255,255,0.8); transition: all 0.2s;
        }
        .btn-float:active { transform: scale(0.9); }
    </style>
</head>
<body class="font-sans antialiased text-slate-800">

    <div id="app-container">
        <div id="top-ui">
            <header class="glass-card">
                <div class="flex items-center gap-3">
                    <!-- Logo "P" Generale -->
                    <div class="logo-gradient w-10 h-10 rounded-2xl text-white">
                        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21V3h4.5a5.5 5.5 0 0 1 0 11H9"></path>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xl font-black tracking-tight text-slate-900 leading-none">ParkMap</span>
                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mt-0.5">Smart Parking</span>
                    </div>
                </div>
                <div class="flex gap-1.5">
                    <button id="locate-btn" title="La mia posizione" class="p-3 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-2xl transition-all active:scale-90">
                        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 2v3m0 14v3m10-10h-3M5 12H2"></path></svg>
                    </button>
                    <button id="info-btn" title="Legenda" class="p-3 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-2xl transition-all active:scale-90">
                        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    </button>
                </div>
            </header>

            <div id="search-container" class="glass-card px-2">
                <div class="relative flex w-full items-center">
                    <div class="absolute left-4 text-slate-400">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="search-input" placeholder="Cerca una via o piazza..." class="w-full bg-transparent py-4 pl-12 pr-4 text-sm font-bold focus:outline-none placeholder:text-slate-400">
                    <button id="search-btn" class="mr-2 bg-blue-600 text-white px-6 py-2.5 rounded-xl text-[11px] font-black shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all uppercase tracking-wider">Vai</button>
                </div>
                <div id="search-results" class="absolute top-full left-0 right-0 mt-3 bg-white/98 backdrop-blur-xl z-[2100] max-h-[350px] overflow-y-auto rounded-[32px] hidden shadow-2xl border border-slate-100 p-2 mx-1"></div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            
            <div id="legend-floating">
                <div class="legend-item"><span class="dot bg-emerald-500"></span> Gratis</div>
                <div class="legend-item"><span class="dot bg-blue-600"></span> Blu</div>
                <div class="legend-item"><span class="dot bg-purple-500"></span> Disco</div>
                <div class="legend-item"><span class="dot bg-yellow-400"></span> Disabili</div>
            </div>

            <button id="refresh-btn" class="btn-float" title="Aggiorna dati">
                <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"></path>
                </svg>
            </button>

            <div id="loader" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[1500] hidden">
                <div class="bg-white/95 backdrop-blur-xl px-7 py-5 rounded-[32px] shadow-2xl border border-white flex items-center gap-4">
                    <div class="w-6 h-6 border-[3px] border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm font-black text-slate-800 tracking-tight">Caricamento posti<span class="loading-dots"></span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-[3000] flex items-center justify-center p-6 transition-opacity duration-300" style="display:none">
        <div class="bg-white rounded-[48px] shadow-2xl p-10 w-full max-w-sm max-h-[85vh] overflow-y-auto border border-white relative">
            <div class="flex flex-col items-center mb-8 text-center">
                <div class="bg-blue-600/10 p-5 rounded-[32px] mb-4">
                    <svg viewBox="0 0 24 24" class="h-10 w-10 text-blue-600" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M9 21V3h4.5a5.5 5.5 0 0 1 0 11H9" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-black text-slate-900 leading-tight">Guida ParkMap</h2>
                <p class="text-slate-400 text-sm font-bold mt-1">Legenda colori e simboli</p>
            </div>
            <div class="space-y-3.5">
                <div class="flex items-center gap-4 bg-emerald-50/50 p-4 rounded-3xl border border-emerald-100/50 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-emerald-500 rounded-full shadow-[0_0_12px_rgba(16,185,129,0.4)]"></span> GRATUITO / LIBERO</div>
                <div class="flex items-center gap-4 bg-blue-50/50 p-4 rounded-3xl border border-blue-100/50 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-blue-600 rounded-full shadow-[0_0_12px_rgba(37,99,235,0.4)]"></span> PAGAMENTO / STRISCE BLU</div>
                <div class="flex items-center gap-4 bg-purple-50/50 p-4 rounded-3xl border border-purple-100/50 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-purple-500 rounded-full shadow-[0_0_12px_rgba(168,85,247,0.4)]"></span> DISCO ORARIO / TEMPO</div>
                <div class="flex items-center gap-4 bg-yellow-50/50 p-4 rounded-3xl border border-yellow-100/50 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-yellow-400 rounded-full shadow-[0_0_12px_rgba(250,204,21,0.4)]"></span> DISABILI (H)</div>
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-3xl border border-slate-100 font-black text-slate-700 text-xs"><span class="text-xl">‚ö°</span> RICARICA ELETTRICA</div>
                <div class="flex items-center gap-4 bg-red-50 p-4 rounded-3xl border border-red-100 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-red-500 rounded-full"></span> BUS / MEZZI PUBBLICI</div>
                <div class="flex items-center gap-4 bg-orange-50 p-4 rounded-3xl border border-orange-100 font-black text-slate-700 text-xs"><span class="w-4 h-4 rounded-full" style="background: #78350f"></span> CARICO / SCARICO</div>
                <div class="flex items-center gap-4 bg-pink-50 p-4 rounded-3xl border border-pink-100 font-black text-slate-700 text-xs"><span class="w-4 h-4 bg-pink-500 rounded-full"></span> POSTI ROSA</div>
            </div>
            <button id="close-info" class="w-full mt-10 bg-slate-900 text-white py-5 rounded-[24px] font-black hover:bg-black transition-all shadow-2xl shadow-slate-300 tracking-widest text-xs uppercase">Chiudi</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false, tap: false, preferCanvas: true, attributionControl: false }).setView([45.4642, 9.1900], 19);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

        let dataLayer = L.layerGroup().addTo(map);
        let isFetching = false;
        let fetchTimeout = null;
        
        const loader = document.getElementById('loader');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const infoModal = document.getElementById('info-modal');

        const colors = {
            free: '#10b981', paid: '#2563eb', timed: '#a855f7', private: '#f97316', 
            disabled: '#facc15', delivery: '#78350f', women: '#ec4899', 
            police: '#1e1b4b', charging: 'transparent', bus: '#ef4444', 
            hgv: '#1e293b', parent: '#fb923c', taxi: '#9333ea', 
            car_sharing: '#6366f1', default: '#64748b' 
        };

        const translations = {
            'yes': 'S√¨', 'public': 'Libero', 'permissive': 'Permesso temporaneo',
            'private': 'Privato', 'residents': 'Residenti', 'customers': 'Clienti',
            'employees': 'Dipendenti', 'permit': 'Solo autorizzati', 'destination': 'Solo destinazione',
            'delivery': 'Carico/Scarico', 'disabled': 'Disabili', 'emergency': 'Solo emergenze',
            'police': 'Forze dell\'ordine', 'no': 'Vietato', 'disc': 'Disco orario',
            'mo': 'Lun', 'tu': 'Mar', 'we': 'Mer', 'th': 'Gio', 'fr': 'Ven', 'sa': 'Sab', 'su': 'Dom',
            'mo-fr': 'Lun-Ven', 'mo-sa': 'Lun-Sab', 'sa-su': 'Sab-Dom', 'off': 'Festivi', 'ph': 'Festivi'
        };

        function humanizeOSM(text) {
            if (!text) return '';
            let t = text.toLowerCase();
            if (t.startsWith('no @')) {
                let giorni = t.split('@')[1].trim().replace(/[()]/g, ''); 
                Object.keys(translations).forEach(key => {
                    const regex = new RegExp(`\\b${key}\\b`, 'g');
                    giorni = giorni.replace(regex, translations[key]);
                });
                return `Accesso vietato: ${giorni.toUpperCase()}`;
            }
            t = t.replace(/(yes|no)\s*@\s*/g, '');
            Object.keys(translations).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'g');
                t = t.replace(regex, translations[key]);
            });
            return t.replace(/[()]/g, '').replace(/;/g, ', ').replace(/\s*,\s*/g, ', ').trim().charAt(0).toUpperCase() + t.slice(1);
        }

        function getParkingType(tags) {
            const acc = tags.access || '';
            const space = tags.parking_space || '';
            const operator = tags.operator || '';
            const amenity = tags.amenity || '';
            
            if (acc === 'police' || tags.designated === 'police' || tags.service === 'police' || space === 'police' || operator.toLowerCase().includes('polizia')) return 'police';
            if (space === 'charging' || tags.charging === 'yes') return 'charging';
            
            if (amenity === 'parking_space') {
                if (tags.disabled === 'yes' || space === 'disabled') return 'disabled';
                if (space === 'delivery') return 'delivery';
                if (space === 'women') return 'women';
                if (space === 'bus') return 'bus';
                if (space === 'hgv') return 'hgv';
                if (space === 'parent') return 'parent';
                if (space === 'taxi') return 'taxi';
                if (space === 'car_sharing') return 'car_sharing';
            }
            
            if (amenity === 'taxi_rank') return 'taxi';
            
            const privateTerms = ['permit', 'residents', 'employees', 'customers', 'private', 'destination', 'no'];
            if (privateTerms.includes(acc)) return 'private';
            
            const fee = tags.fee || '';
            if (fee === 'yes' || tags['fee:conditional']) return 'paid';
            
            const cond = tags['parking:condition'] || tags['parking:condition:both'] || '';
            if (cond.includes('disc') || tags['maxstay']) return 'timed';
            
            return 'free';
        }

        function getIconChar(tags) {
            const s = tags.parking_space || '';
            const acc = tags.access || '';
            if (tags.disabled === 'yes' || s === 'disabled') return '‚ôø';
            if (s === 'delivery') return 'üöö';
            if (s === 'women') return '‚ôÄ';
            if (s === 'police' || acc === 'police' || tags.service === 'police') return 'üöî';
            if (s === 'charging' || tags.charging === 'yes') return '‚ö°';
            if (s === 'bus') return 'üöå';
            if (s === 'hgv') return 'üöõ';
            if (s === 'parent') return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            if (s === 'taxi' || tags.amenity === 'taxi_rank') return 'üöï';
            if (s === 'car_sharing') return 'üöó';
            return '';
        }

        function getPopupContent(el, lat, lon) {
            const t = el.tags;
            const type = getParkingType(t);
            const isS = t.amenity === 'parking_space';
            let title = t.name || (isS ? "Posto Singolo" : "Area Parcheggio");
            const labels = {
                paid: "Pagamento", timed: "Disco Orario", disabled: "Disabili",
                delivery: "Carico/Scarico", women: "Posto Rosa", police: "Forze dell'Ordine",
                private: "Riservato", charging: "Ricarica Elettrica", bus: "Bus/Pullman",
                hgv: "Mezzi Pesanti", parent: "Famiglie", taxi: "Taxi",
                car_sharing: "Car Sharing", free: "Gratis"
            };
            
            let details = [];
            
            // Accesso
            const access = t.access || '';
            const accessCond = t['access:conditional'] || '';
            if (accessCond) {
                details.push(`<div class="popup-tag text-red-700 bg-red-50 border-red-100">üîí ${humanizeOSM(accessCond)}</div>`);
            } else if (access && access !== 'yes' && access !== 'public') {
                const motivo = translations[access] || access;
                details.push(`<div class="popup-tag text-orange-700 bg-orange-50 border-orange-100">üîí Riservato: ${humanizeOSM(motivo)}</div>`);
            }
            
            // Tariffa
            if (t.fee === 'yes' && !t['fee:conditional']) {
                const charge = t.charge || t['fee:amount'] || '';
                details.push(`<div class="popup-tag text-blue-700 bg-blue-50 border-blue-100">üí∞ Pagamento${charge ? ': ' + charge : ''}</div>`);
            }
            
            if (t['fee:conditional']) {
                const rawCond = t['fee:conditional'].toLowerCase();
                const readableCond = humanizeOSM(t['fee:conditional']);
                if (rawCond.includes('yes')) {
                    details.push(`<div class="popup-tag text-blue-700 bg-blue-50 border-blue-100">üí∞ Pagamento: ${readableCond}</div>`);
                    details.push(`<div class="popup-tag text-emerald-700 bg-emerald-50 border-emerald-100">‚úÖ Gratis: orari restanti</div>`);
                } else if (rawCond.includes('no')) {
                    details.push(`<div class="popup-tag text-emerald-700 bg-emerald-50 border-emerald-100">‚úÖ Gratis: ${readableCond}</div>`);
                    details.push(`<div class="popup-tag text-blue-700 bg-blue-50 border-blue-100">üí∞ Pagamento: orari restanti</div>`);
                }
            }
            
            // Disco orario e maxstay
            if (t.maxstay) details.push(`<div class="popup-tag text-purple-700 bg-purple-50 border-purple-100">‚åõ Max: ${t.maxstay.replace('mins', 'min')}</div>`);
            const cond = t['parking:condition'] || t['parking:condition:both'];
            if (cond && cond.includes('disc') && !type === 'timed') {
                 details.push(`<div class="popup-tag text-purple-700 bg-purple-50 border-purple-100">üÖøÔ∏è Disco Orario</div>`);
            }

            if (t.capacity) details.push(`<div class="popup-tag text-slate-500 border border-slate-100">üìç Posti totali: ${t.capacity}</div>`);
            if (t.operator) details.push(`<div class="popup-tag text-slate-500 border border-slate-100">üè¢ Gestore: ${t.operator}</div>`);
            
            return `
                <div class="flex flex-col gap-3">
                    <h3 class="text-base font-black text-slate-900">${title}</h3>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 font-bold text-xs">
                        <div class="flex items-center text-slate-400 uppercase tracking-widest text-[9px] mb-2">
                            <span class="w-2.5 h-2.5 rounded-full mr-2" style="background: ${colors[type]}"></span>
                            ${labels[type] || "Area Parcheggio"}
                        </div>
                        <div class="flex flex-col gap-1.5">
                            ${details.join('')}
                        </div>
                    </div>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="btn-action bg-blue-600 py-3.5 rounded-2xl text-[11px] font-black tracking-widest shadow-lg shadow-blue-100">NAVIGA ORA</a>
                </div>`;
        }

        async function fetchParking() {
            if (isFetching || map.getZoom() < 15) return;
            isFetching = true;
            loader.style.display = 'block';
            
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            
            const q = `[out:json][timeout:25];(
                nwr["amenity"="parking"](${bbox});
                nwr["amenity"="parking_space"](${bbox});
                nwr["amenity"="taxi_rank"](${bbox});
            );out geom;`;
            
            try {
                const r = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: q });
                if (r.ok) {
                    const d = await r.json();
                    renderData(d.elements);
                }
            } catch (e) { console.error(e); }
            isFetching = false; 
            loader.style.display = 'none';
        }

        function renderData(elements) {
            dataLayer.clearLayers();
            
            elements.sort((a, b) => {
                const scoreA = a.tags.amenity === 'parking_space' ? 10 : 0;
                const scoreB = b.tags.amenity === 'parking_space' ? 10 : 0;
                return scoreA - scoreB;
            }).forEach(el => {
                const isSpace = el.tags.amenity === 'parking_space';
                
                if (isSpace && el.tags.parking_space === 'normal') {
                    return;
                }

                const type = getParkingType(el.tags);
                const char = getIconChar(el.tags);
                
                let coords = el.geometry ? el.geometry.map(p => [p.lat, p.lon]) : [];
                const isPolygon = coords.length > 2;
                
                let center = isPolygon ? [coords.reduce((a,b)=>a+b[0],0)/coords.length, coords.reduce((a,b)=>a+b[1],0)/coords.length] : (el.center ? [el.center.lat, el.center.lon] : (el.lat ? [el.lat, el.lon] : (coords[0] || null)));
                if (!center) return;

                if (type === 'free' && !isPolygon) return;

                let layer;
                if (isPolygon) {
                    layer = L.polygon(coords, { 
                        fillColor: colors[type], 
                        color: (isSpace && type !== 'free') ? 'white' : colors[type], 
                        weight: (isSpace && type !== 'free') ? 2 : 1, 
                        fillOpacity: (isSpace && type !== 'free') ? 0.9 : 0.3 
                    }).addTo(dataLayer);
                } else {
                    layer = L.circle(center, { 
                        radius: isSpace ? 3.5 : 5, 
                        fillColor: colors[type], 
                        color: 'white', 
                        weight: 2, 
                        fillOpacity: 0.9 
                    }).addTo(dataLayer);
                }

                if (layer) layer.bindPopup(getPopupContent(el, center[0], center[1]));

                if (char && type !== 'free') {
                    L.marker(center, { 
                        icon: L.divIcon({ 
                            html: char, 
                            className: type === 'charging' ? 'charging-icon' : 'parking-space-icon', 
                            iconSize: type === 'charging' ? [28, 28] : [22, 22], 
                            iconAnchor: type === 'charging' ? [14, 14] : [11, 11] 
                        }), 
                        interactive: false, 
                        zIndexOffset: 3000 
                    }).addTo(dataLayer);
                }
            });
        }

        map.on('moveend', () => { 
            clearTimeout(fetchTimeout); 
            fetchTimeout = setTimeout(fetchParking, 800); 
        });

        document.getElementById('refresh-btn').onclick = () => {
            const btn = document.querySelector('#refresh-btn svg');
            btn.parentElement.classList.add('animate-spin');
            fetchParking().finally(() => {
                setTimeout(() => btn.parentElement.classList.remove('animate-spin'), 1000);
            });
        };

        document.getElementById('info-btn').onclick = () => infoModal.style.display = 'flex';
        document.getElementById('close-info').onclick = () => infoModal.style.display = 'none';
        document.getElementById('locate-btn').onclick = () => map.locate({setView: true, maxZoom: 19});
        
        document.getElementById('search-btn').onclick = async () => {
            const v = searchInput.value;
            if (v.length < 3) return;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(v)}&countrycodes=it&limit=5`, { headers: { 'Accept-Language': 'it' } });
            if (r.ok) {
                const json = await r.json();
                searchResults.innerHTML = '';
                if (json.length === 0) {
                    searchResults.innerHTML = '<div class="p-6 text-sm text-slate-400 font-bold text-center">Nessun risultato trovato</div>';
                } else {
                    json.forEach(res => {
                        const d = document.createElement('div');
                        d.className = 'p-4 hover:bg-blue-50 cursor-pointer text-sm font-black border-b border-slate-50 last:border-0 rounded-2xl transition-colors text-slate-700';
                        d.textContent = res.display_name;
                        d.onclick = () => { 
                            map.setView([res.lat, res.lon], 19); 
                            searchResults.style.display = 'none'; 
                            fetchParking(); 
                        };
                        searchResults.appendChild(d);
                    });
                }
                searchResults.style.display = 'block';
            }
        };

        window.onclick = (e) => { if (e.target == infoModal) infoModal.style.display = "none"; };
        window.onload = fetchParking;
    </script>
</body>
</html>
